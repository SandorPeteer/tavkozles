<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Manuális Start/Stop Polaritás Teszt</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f7f7f7;
      text-align: center;
      margin: 20px;
    }
    h1 { color: #333; }
    .section {
      border: 1px solid #ccc;
      background: #eee;
      padding: 10px;
      margin: 10px;
    }
    button, select {
      font-size: 1rem;
      margin: 0.5rem;
      padding: 0.3rem 0.8rem;
    }
    #canvas {
      border: 1px solid #ccc;
      background: #fff;
      margin: 20px auto;
      display: block;
    }
  </style>
</head>
<body>
  <h1>Manuális Polaritás Teszt – Start/Stop</h1>
  
  <!-- Adó (Transmitter) rész -->
  <div id="transmitterSection" class="section">
    <h2>Adó (Transmitter)</h2>
    <label for="txPolaritySelect">Tesztjel polaritása:</label>
    <select id="txPolaritySelect">
      <option value="normal">Normál (pozitív csúcs)</option>
      <option value="inverted">Inverz (negatív csúcs)</option>
    </select>
    <br>
    <button id="txStartBtn">Adó Start</button>
    <button id="txStopBtn">Adó Stop</button>
    <p id="txStatus">Adó: várakozás...</p>
  </div>
  
  <!-- Vevő (Receiver) rész -->
  <div id="receiverSection" class="section">
    <h2>Vevő (Receiver)</h2>
    <button id="rxStartBtn">Vevő Start</button>
    <button id="rxStopBtn">Vevő Stop</button>
    <p id="rxResult">Eredmény: várakozás...</p>
  </div>
  
  <!-- Canvas (opcionális, a jel vizualizálásához) -->
  <canvas id="canvas" width="800" height="200"></canvas>
  <p id="status">Állapot: várakozás...</p>
  
  <script>
    /********** Globális változók **********/
    let audioContext = null;
    let mode = "transmitter"; // ide nem szükséges üzemmód váltás, mert külön eszközökön futtatjuk
    const statusElem = document.getElementById("status");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    
    // --- Adó oldal paraméterei ---
    // Egyszerű tesztjel: egy 500 Hz-es tónus, melyet a felhasználó polaritásának megfelelően (normál vagy inverz) játszunk le
    // A jel 0.5 s hosszú, majd 0.5 s csend → periódus 1 s
    const toneFreq = 500;       // 500 Hz
    const toneDuration = 0.5;    // 0.5 s
    const silenceDuration = 0.5; // 0.5 s csend
    const txPeriod = toneDuration + silenceDuration;
    
    // --- Vevő oldal változói ---
    let rxStream = null;
    let rxProcessor = null;
    let rxCapturing = false; // Ezt a felhasználó indítja/állítja le
    let ringBuffer = [];     // itt gyűjtjük a mikrofonból érkező adatokat
    
    // --- AudioContext létrehozása ---
    function ensureAudioContext() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
    }
    
    /********** Adó oldal: Tesztjel generálása és lejátszása **********/
    function generateTestTone(txPolarity) {
      ensureAudioContext();
      const sampleRate = audioContext.sampleRate;
      const length = Math.floor(toneDuration * sampleRate);
      const buffer = new Float32Array(length);
      for (let i = 0; i < length; i++) {
        const t = i / sampleRate;
        let sample = Math.sin(2 * Math.PI * toneFreq * t);
        // Alkalmazzuk a polaritást: normál esetben marad +, inverz esetben megfordítjuk
        if (txPolarity === "inverted") {
          sample = -sample;
        }
        buffer[i] = sample;
      }
      return buffer;
    }
    
    function playTestTone() {
      ensureAudioContext();
      const txPolarity = document.getElementById("txPolaritySelect").value;
      const toneData = generateTestTone(txPolarity);
      const sampleRate = audioContext.sampleRate;
      // Létrehozunk egy bufferet a tónushoz
      const toneBuffer = audioContext.createBuffer(1, toneData.length, sampleRate);
      toneBuffer.copyToChannel(toneData, 0);
      const toneSource = audioContext.createBufferSource();
      toneSource.buffer = toneBuffer;
      toneSource.connect(audioContext.destination);
      toneSource.start();
      // Most hozzunk létre egy csendet is a periódus befejezéséhez:
      const silenceSamples = Math.floor(silenceDuration * sampleRate);
      const silenceBuffer = new Float32Array(silenceSamples); // minden elem 0
      const silenceAudioBuffer = audioContext.createBuffer(1, silenceBuffer.length, sampleRate);
      silenceAudioBuffer.copyToChannel(silenceBuffer, 0);
      const silenceSource = audioContext.createBufferSource();
      silenceSource.buffer = silenceAudioBuffer;
      silenceSource.connect(audioContext.destination);
      silenceSource.start(audioContext.currentTime + toneDuration);
      
      // Rajzoljuk ki a tónus hullámformáját a canvas-ra (csak a tónus rész)
      drawWaveform(toneData);
      
      document.getElementById("txStatus").textContent =
        "Adó: " + new Date().toLocaleTimeString() + " – tesztjel lejátszva (" + txPolarity + ")";
      statusElem.textContent = "Adó: tesztjel lejátszva";
    }
    
    // Folyamatosan ismételjük az adó oldalon a jel lejátszását
    let txIntervalId = null;
    function startTransmitter() {
      ensureAudioContext();
      playTestTone();
      txIntervalId = setInterval(playTestTone, txPeriod * 1000);
    }
    
    function stopTransmitter() {
      if (txIntervalId) {
        clearInterval(txIntervalId);
        txIntervalId = null;
      }
      document.getElementById("txStatus").textContent = "Adó: leállítva";
      statusElem.textContent = "Adó: leállítva";
    }
    
    /********** Vevő oldal: Start/Stop alapú rögzítés és elemzés **********/
    // A felvétel során a ringBufferbe gyűjtjük a mikrofon adatait.
    // Amikor a felhasználó a "Receiver Stop" gombot nyomja, leállítjuk a felvételt,
    // majd a ringBuffer-ből kiválasztjuk a legnagyobb amplitúdójú részt, és egy rövid ablakban kiszámoljuk az átlag előjelét.
    function analyzeCapturedSignal() {
      ensureAudioContext();
      if (ringBuffer.length === 0) {
        document.getElementById("rxResult").textContent = "Eredmény: Nincs rögzített adat";
        return;
      }
      // Keressük meg a maximum abszolút értékű mintát
      let maxVal = 0;
      let maxIndex = 0;
      for (let i = 0; i < ringBuffer.length; i++) {
        const absVal = Math.abs(ringBuffer[i]);
        if (absVal > maxVal) {
          maxVal = absVal;
          maxIndex = i;
        }
      }
      // Vegyünk egy ±20 minta ablakot a csúcspont körül
      const windowSize = 20;
      let sum = 0, count = 0;
      for (let i = Math.max(0, maxIndex - windowSize); i < Math.min(ringBuffer.length, maxIndex + windowSize); i++) {
        sum += ringBuffer[i];
        count++;
      }
      const avg = sum / count;
      let result = "";
      if (avg > 0) {
        result = "Normál";
      } else if (avg < 0) {
        result = "Inverz";
      } else {
        result = "Nem meghatározható";
      }
      document.getElementById("rxResult").textContent =
        "Eredmény: " + result + " polaritás (átlag: " + avg.toFixed(2) + ")";
      // Frissítsük a canvas-t a kiválasztott ablak adataival (opcionális)
      const segment = ringBuffer.slice(Math.max(0, maxIndex - windowSize), Math.min(ringBuffer.length, maxIndex + windowSize));
      drawWaveform(segment);
    }
    
    function startReceiver() {
      ensureAudioContext();
      rxCapturing = true;
      ringBuffer = []; // ürítjük az előző felvételt
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(function(stream) {
          rxStream = stream;
          const source = audioContext.createMediaStreamSource(stream);
          rxProcessor = audioContext.createScriptProcessor(2048, 1, 1);
          source.connect(rxProcessor);
          // A csatlakozás a destination-re opcionális
          rxProcessor.connect(audioContext.destination);
          rxProcessor.onaudioprocess = function(e) {
            if (!rxCapturing) return; // ha leállítottuk a felvételt, ne gyűjtsünk több adatot
            const inputData = e.inputBuffer.getChannelData(0);
            ringBuffer = ringBuffer.concat(Array.from(inputData));
            // Nem frissítjük folyamatosan a canvas-t, mert az erőforrásokat a vételre koncentráljuk
          };
          document.getElementById("rxResult").textContent = "Vevő: rögzítés folyamatban...";
          statusElem.textContent = "Vevő: rögzítés folyamatban...";
        })
        .catch(function(err) {
          document.getElementById("rxResult").textContent = "Hiba: mikrofonhoz való hozzáférés megtagadva!";
          console.error(err);
        });
    }
    
    function stopReceiver() {
      rxCapturing = false;
      if (rxProcessor) {
        rxProcessor.disconnect();
        rxProcessor = null;
      }
      if (rxStream) {
        rxStream.getTracks().forEach(track => track.stop());
        rxStream = null;
      }
      analyzeCapturedSignal();
      statusElem.textContent = "Vevő: leállítva";
    }
    
    /********** Canvas rajzoló **********/
    function drawWaveform(data) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.beginPath();
      const midY = canvas.height / 2;
      const scaleX = canvas.width / data.length;
      const scaleY = canvas.height / 2;
      ctx.moveTo(0, midY);
      for (let i = 0; i < data.length; i++) {
        const x = i * scaleX;
        const y = midY - data[i] * scaleY;
        ctx.lineTo(x, y);
      }
      ctx.strokeStyle = "#0077cc";
      ctx.stroke();
    }
    
    /********** UI vezérlés **********/
    document.getElementById("txStartBtn").addEventListener("click", function() {
      ensureAudioContext();
      if (audioContext.state === "suspended") audioContext.resume();
      startTransmitter();
    });
    
    document.getElementById("txStopBtn").addEventListener("click", stopTransmitter);
    
    document.getElementById("rxStartBtn").addEventListener("click", function() {
      ensureAudioContext();
      if (audioContext.state === "suspended") audioContext.resume();
      startReceiver();
    });
    
    document.getElementById("rxStopBtn").addEventListener("click", stopReceiver);
    
    // Egy kattintás a dokumentumon feloldja az AudioContext-et (néhány böngészőben szükséges)
    document.body.addEventListener("click", function() {
      if (audioContext && audioContext.state === "suspended") {
        audioContext.resume();
      }
    });
  </script>
</body>
</html>
